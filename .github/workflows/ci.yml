name: ğŸš€ DÃ©ploiement Lexique MÃ©tÃ©orologique

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

# Permettre un seul dÃ©ploiement concurrent
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job de construction
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Cache des dÃ©pendances
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/environment.yml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ”§ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocs-material gtts pydub
        
    - name: ğŸµ GÃ©nÃ©ration des fichiers audio
      env:
        # Utiliser une clÃ© d'API si nÃ©cessaire pour gTTS
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "ğŸµ GÃ©nÃ©ration des fichiers audio..."
        python generate_audio.py || echo "âš ï¸ GÃ©nÃ©ration audio Ã©chouÃ©e - continuons sans audio"
        
    - name: ğŸ“„ GÃ©nÃ©ration des pages
      run: |
        echo "ğŸ“„ GÃ©nÃ©ration des pages Markdown..."
        python generate_pages.py
        
    - name: ğŸ—ï¸ Construction MkDocs
      run: |
        echo "ğŸ—ï¸ Construction du site MkDocs..."
        mkdocs build --verbose --clean
        
    - name: ğŸ“‹ VÃ©rification du build
      run: |
        echo "ğŸ“‹ VÃ©rification des fichiers gÃ©nÃ©rÃ©s..."
        ls -la site/
        echo "ğŸ“Š Taille du site: $(du -sh site/ | cut -f1)"
        echo "ğŸ“„ Nombre de pages: $(find site/ -name "*.html" | wc -l)"
        
    - name: ğŸ“¤ Upload des artifacts
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./site

  # Job de dÃ©ploiement
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸš€ DÃ©ploiement sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      
    - name: ğŸ‰ Notification de succÃ¨s
      run: |
        echo "ğŸ‰ DÃ©ploiement rÃ©ussi !"
        echo "ğŸŒ Site disponible Ã : ${{ steps.deployment.outputs.page_url }}"
        
  # Job de notification (optionnel)
  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
    - name: ğŸ“Š RÃ©sumÃ© du dÃ©ploiement
      run: |
        if [[ "${{ needs.build.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
          echo "âœ… SUCCÃˆS - Lexique mÃ©tÃ©orologique dÃ©ployÃ© avec succÃ¨s !"
          echo "ğŸŒ Accessible sur GitHub Pages"
          echo "ğŸ“± Compatible mobile, tablette et desktop"
          echo "ğŸ”Š FonctionnalitÃ©s audio disponibles"
        elif [[ "${{ needs.build.result }}" == "failure" ]]; then
          echo "âŒ Ã‰CHEC - Erreur lors de la construction"
          echo "ğŸ” VÃ©rifiez les logs de construction ci-dessus"
        elif [[ "${{ needs.deploy.result }}" == "failure" ]]; then
          echo "âŒ Ã‰CHEC - Erreur lors du dÃ©ploiement"
          echo "ğŸ” VÃ©rifiez la configuration GitHub Pages"
        else
          echo "âš ï¸ STATUT INCONNU - VÃ©rifiez les logs"
        fi